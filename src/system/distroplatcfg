#!/bin/bash
set +e

log() { echo "[INFO] $*"; }

safe_run() {
    "$@"
    local status=$?
    if [[ $status -ne 0 ]]; then
        echo "[WARN] Command failed: $* (exit code $status)"
    fi
    return $status
}

# Safely disable systemd service
safe_disable_service() {
    local service=$1
    if systemctl list-unit-files | grep -q "^$service.service"; then
        safe_run systemctl disable "$service" --now
    fi
}

# Safely mask systemd service
safe_mask_service() {
    local service=$1
    if systemctl list-unit-files | grep -q "^$service.service"; then
        safe_run systemctl mask "$service"
    fi
}

log "Sourcing board_id.sh"
source /usr/bin/board_id.sh
board_id=$(get_board_id)

: ${board_id:?}

log "Detected board: $board_id"

case "${board_id}" in
    imx8mm*)
        safe_run sed -i "s/.*pam_nologin.*/auth    requisite       pam_nologin.so nullok/" /etc/pam.d/gdm-password
        safe_run sed -e  's/.*AutomaticLoginEnable.*/AutomaticLoginEnable = true/'  -e '0,/user1/s/.*user1.*/AutomaticLogin = debian/'  -i /etc/gdm3/daemon.conf
        safe_run grep -q 'WantedBy=graphical.target' /lib/systemd/system/gdm.service || \
            sed -i '$a\[Install]\nWantedBy=graphical.target' /lib/systemd/system/gdm.service
        safe_run ln -sf /lib/systemd/system/gdm.service /etc/systemd/system/graphical.target.wants/gdm.service

        safe_run ln -sf vsidaemon-IMX8MM /usr/bin/vsidaemon
        safe_run ln -sf weston.ini.imx8mm /etc/xdg/weston/weston.ini
        if [ -f /lib/aarch64-linux-gnu/libmutter-16.so.0.0.0 ]; then
            safe_run /usr/bin/patchelf --replace-needed libGL.so.1 libGLESv2.so.2 /lib/aarch64-linux-gnu/libmutter-16.so.0.0.0
        fi
        sed -i 's|^Exec=.*|Exec=/usr/lib/chromium/chromium --ozone-platform=wayland --password-store=basic %U|' \
            /usr/share/applications/chromium.desktop
        /usr/bin/update-desktop-database
        ;;
    imx8mp*)
        safe_run sed -i "s/.*pam_nologin.*/auth    requisite       pam_nologin.so nullok/" /etc/pam.d/gdm-password
        safe_run sed -e  's/.*AutomaticLoginEnable.*/AutomaticLoginEnable = true/'  -e '0,/user1/s/.*user1.*/AutomaticLogin = debian/'  -i /etc/gdm3/daemon.conf
        safe_run grep -q 'WantedBy=graphical.target' /lib/systemd/system/gdm.service || \
            sed -i '$a\[Install]\nWantedBy=graphical.target' /lib/systemd/system/gdm.service
        safe_run ln -sf /lib/systemd/system/gdm.service /etc/systemd/system/graphical.target.wants/gdm.service

        # libcamera is not supported on imx8mpevk
        safe_run mv /usr/lib/gstreamer-1.0/libgstlibcamera.so /usr/lib/gstreamer-1.0/libgstlibcamera.so.bak

        safe_run ln -sf /lib/systemd/system/imx8-isp.service /etc/systemd/system/multi-user.target.wants/imx8-isp.service
        safe_run ln -sf vsidaemon-IMX8MP /usr/bin/vsidaemon
        if [ -f /lib/aarch64-linux-gnu/libmutter-16.so.0.0.0 ]; then
            safe_run /usr/bin/patchelf --replace-needed libGL.so.1 libGLESv2.so.2 /lib/aarch64-linux-gnu/libmutter-16.so.0.0.0
        fi
        safe_run ln -sf weston.ini.imx8mp /etc/xdg/weston/weston.ini
        sed -i 's|^Exec=.*|Exec=/usr/lib/chromium/chromium --ozone-platform=wayland --password-store=basic %U|' \
            /usr/share/applications/chromium.desktop
        /usr/bin/update-desktop-database
        ;;
    imx8qm*)
        safe_run sed -i "s/.*pam_nologin.*/auth    requisite       pam_nologin.so nullok/" /etc/pam.d/gdm-password
        safe_run sed -e  's/.*AutomaticLoginEnable.*/AutomaticLoginEnable = true/'  -e '0,/user1/s/.*user1.*/AutomaticLogin = debian/'  -i /etc/gdm3/daemon.conf
        safe_run grep -q 'WantedBy=graphical.target' /lib/systemd/system/gdm.service || \
            sed -i '$a\[Install]\nWantedBy=graphical.target' /lib/systemd/system/gdm.service
        safe_run ln -sf /lib/systemd/system/gdm.service /etc/systemd/system/graphical.target.wants/gdm.service

        # libcamera is not supported on imx8mpevk
        safe_run mv /usr/lib/gstreamer-1.0/libgstlibcamera.so /usr/lib/gstreamer-1.0/libgstlibcamera.so.bak

        if [ -f /lib/aarch64-linux-gnu/libmutter-16.so.0.0.0 ]; then
            safe_run /usr/bin/patchelf --replace-needed libGL.so.1 libGLESv2.so.2 /lib/aarch64-linux-gnu/libmutter-16.so.0.0.0
        fi
        safe_run ln -sf weston.ini.imx8qm /etc/xdg/weston/weston.ini
        sed -i 's|^Exec=.*|Exec=/usr/lib/chromium/chromium --ozone-platform=wayland --password-store=basic %U|' \
            /usr/share/applications/chromium.desktop
        /usr/bin/update-desktop-database
        ;;
    imx91*)
        safe_run rm -rf /etc/systemd/system/display-manager.service
        safe_run ln -sf weston.ini.imx91 /etc/xdg/weston/weston.ini
        safe_run systemctl enable weston
        ;;
    imx93*)
        safe_run ln -sf libg2d-pxp.so.2.4.0 /usr/lib/libg2d.so.2
        if [ -f /usr/lib/libg2d-pxp.so.2.4.0 ]; then
            safe_run rm -f /usr/lib/libg2d-viv.so.2.4.0
        fi
        safe_run rm -rf /etc/systemd/system/display-manager.service
        safe_run ln -sf weston.ini.imx93 /etc/xdg/weston/weston.ini
        safe_run systemctl enable weston
        ;;
    imx95*)
        safe_run sed -i "s/.*pam_nologin.*/auth    requisite       pam_nologin.so nullok/" /etc/pam.d/gdm-password
        safe_run sed -e  's/.*AutomaticLoginEnable.*/AutomaticLoginEnable = true/'  -e '0,/user1/s/.*user1.*/AutomaticLogin = debian/'  -i /etc/gdm3/daemon.conf
        safe_run grep -q 'WantedBy=graphical.target' /lib/systemd/system/gdm.service || \
            sed -i '$a\[Install]\nWantedBy=graphical.target' /lib/systemd/system/gdm.service
        safe_run ln -sf /lib/systemd/system/gdm.service /etc/systemd/system/graphical.target.wants/gdm.service

        safe_run ln -sf weston.ini.imx95 /etc/xdg/weston/weston.ini
        if [ -f /lib/aarch64-linux-gnu/libmutter-16.so.0.0.0 ]; then
            safe_run /usr/bin/patchelf --replace-needed libGL.so.1 libGLESv2.so.2 /lib/aarch64-linux-gnu/libmutter-16.so.0.0.0
        fi
        sed -i 's|^Exec=.*|Exec=/usr/lib/chromium/chromium --ozone-platform=wayland --password-store=basic %U|' \
            /usr/share/applications/chromium.desktop
        /usr/bin/update-desktop-database
        ;;
    ls1028a*)
        safe_run ln -sf weston.ini.ls1028 /etc/xdg/weston/weston.ini
        safe_run rm -rf /etc/systemd/system/display-manager.service
        safe_run systemctl enable weston
        ;;
    ls1043*|ls1046*)
        safe_run ln -sf /lib/systemd/system/fmc.service /etc/systemd/system/multi-user.target.wants/fmc.service
        ;;
esac

# disable speed up firmware loading since ap1302 firmware is slow
#if [ -f /usr/lib/udev/rules.d/50-firmware.rules ]; then
#    safe_run sed -i 's/^SUBSYSTEM/#SUBSYSTEM/' /usr/lib/udev/rules.d/50-firmware.rules
#fi
safe_run /usr/bin/hostnamectl set-hostname "${board_id}"

safe_disable_service strongswan

### network config
# disable rename network interface
safe_run ln -sf /dev/null /etc/udev/rules.d/80-net-setup-link.rules

# disable legacy networking service
safe_disable_service networking

safe_run systemctl enable systemd-networkd --now

# disable wpa_supplicant since it always print logs
safe_mask_service wpa_supplicant

# disable systemd-networkd-wait-online to speed up the boot
safe_disable_service systemd-networkd-wait-online
safe_disable_service NetworkManager-wait-online

if [ -d /usr/share/glib-2.0/schemas/ ]; then
    safe_run /usr/bin/glib-compile-schemas /usr/share/glib-2.0/schemas/ >/dev/null 2>&1
fi
safe_run /usr/sbin/ldconfig
safe_run /usr/sbin/depmod -a
safe_run /usr/sbin/update-initramfs -u

# disable itself because it runs only ones.
systemctl disable platcfg.service &>/dev/null || true

safe_run dpkg --configure -a
safe_run systemctl daemon-reload

if [[ $PPID -eq 1 ]] && [[ -f /etc/systemd/system/graphical.target.wants/weston.service ]]; then
    safe_run systemctl start weston
fi

log "Board initialization finished."

