#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

DISTRVER=lsdk2512

LS_MACHINE_LIST="ls1012ardb ls1012afrwy ls1028ardb ls1043ardb ls1046ardb ls1046afrwy ls1088ardb ls2088ardb lx2160ardb "
IMX_MACHINE_LIST="imx8mpfrdm imx93evk imx93frdm imx8mqevk imx91sfrdm imx8mnevk imx8qxpmek imx8mpevk imx8qmmek imx8mmevk imx91frdm imx8ulpevk imx91evk imx95evk imx95frdm"
DEFAULT_DL_URL="https://www.nxp.com/lgfiles/sdk/$DISTRVER"

show_one_line() {
    "$@" 2>&1 | while IFS= read -r line; do
        printf "\033[1A\033[2K\r%s\n" "$line"
    done
}

check_board_valid() {
    if [ -z "${MACHINE:-}" ] || [ "$MACHINE" = "all" ]; then
        echo -e "Error: can't detect the board name, please check if DTB is used correctly.\n"
        exit 1
    fi
    if ! echo "$LS_MACHINE_LIST $IMX_MACHINE_LIST" | grep -qw "$MACHINE"; then
        echo "Error: Invalid board: '$MACHINE'."
        echo "LS_MACHINE_LIST: $LS_MACHINE_LIST"
        echo "IMX_MACHINE_LIST: $IMX_MACHINE_LIST"
        exit 1
    fi
}

check_network() {
    if ! ping -c 2 deb.debian.org &>/dev/null; then
        echo "ERROR: Unable to access deb.debian.org. Check network connectivity."
        exit 1
    fi

    if [ -n "${http_proxy:-}" ] && ! grep -iq 'acquire::http::proxy' /etc/apt/apt.conf 2>/dev/null; then
        echo "ERROR: HTTP proxy is set in environment but not configured in /etc/apt/apt.conf"
        exit 1
    fi
}

apt_install_with_retry() {
    local packages=("$@")
    local max_retries=3
    local success=false

    for ((attempt=1; attempt<=max_retries; attempt++)); do
        echo "Installing packages (attempt $attempt)"
        if show_one_line sudo DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y "${packages[@]}"; then
            success=true
            break
        else
            echo "Warning: Attempt $attempt failed, retrying in 5 seconds"
            sleep 5
            show_one_line sudo DEBIAN_FRONTEND=noninteractive apt-get clean &>/dev/null
            show_one_line sudo DEBIAN_FRONTEND=noninteractive apt-get update --fix-missing &>/dev/null
            show_one_line sudo DEBIAN_FRONTEND=noninteractive apt-get --fix-broken install &>/dev/null
        fi
    done

    if ! $success; then
        echo "ERROR: Failed to install packages after $max_retries attempts."
        exit 1
    fi
}

download_and_install_deb() {
    local url="$1"
    local deb="$2"
    rm -f "$deb"

    echo -e "\nDownloading $deb"
    if ! wget --no-check-certificate --tries=3 --timeout=100 --continue --progress=bar --no-verbose --show-progress "$url/$deb"; then
        echo "ERROR: Download $deb failed. Please try again."
        exit 1
    fi

    echo "Installing $deb"
    show_one_line sudo dpkg -i --force-overwrite "$deb"
    rm -f "$deb"
}

main() {
    source /usr/bin/board_id.sh
    local board_id
    board_id=$(get_board_id)

    MACHINE="$board_id"
    check_board_valid

    if [[ -n "${1:-}" && ! "$1" =~ ^http ]]; then
        echo "Usage: debian-post-install-pkg [url]"
        exit 0
    fi

    source /etc/extra_packages_list || true
    check_network

    [ -f "/etc/ts.conf" ] && mv /etc/ts.conf /etc/ts.conf.bak

    echo "Updating package list"
    show_one_line sudo apt-get update -y

    case "$board_id" in
        imx95*) NXPAPPSPKG=nxp_apps_debian_"${DISTRVER}"_imx95evk.deb; PKGS=("${ls_pkgs[@]}" "${imx_pkgs[@]}" "${gnome_pkgs[@]}");;
        imx8*)  NXPAPPSPKG=nxp_apps_debian_"${DISTRVER}"_imx8mpevk.deb; PKGS=("${ls_pkgs[@]}" "${imx_pkgs[@]}" "${gnome_pkgs[@]}");;
        imx93*) NXPAPPSPKG=nxp_apps_debian_"${DISTRVER}"_imx93evk.deb; PKGS=("${ls_pkgs[@]}" "${imx_pkgs[@]}");;
        imx91*) NXPAPPSPKG=nxp_apps_debian_"${DISTRVER}"_imx91evk.deb; PKGS=("${ls_pkgs[@]}" "${imx_pkgs[@]}");;
        l*) NXPAPPSPKG=nxp_apps_debian_"${DISTRVER}"_ls1028ardb.deb; PKGS=("${ls_pkgs[@]}");;
    esac

    apt_install_with_retry apt-utils "${base_pkgs[@]}" "${PKGS[@]}"

    local pkglink="${1:-$DEFAULT_DL_URL}"
    download_and_install_deb "$pkglink" "$NXPAPPSPKG"

    echo "Cleaning up"
    sudo apt-get clean
    sudo apt-get autoclean
    sudo apt-get autoremove -y

    [ -f "/etc/ts.conf.bak" ] && mv /etc/ts.conf.bak /etc/ts.conf

    echo "Configuring system"
    /usr/bin/distroplatcfg

    echo "System is ready. Please reboot now."
}

main "$@"

