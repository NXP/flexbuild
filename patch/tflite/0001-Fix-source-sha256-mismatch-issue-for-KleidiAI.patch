From 27eaf2a3f785a24f664de11b3f54434f0140de69 Mon Sep 17 00:00:00 2001
From: Andy Tang <andy.tang@nxp.com>
Date: Tue, 20 Jan 2026 09:00:19 +0800
Subject: [PATCH] Fix source sha256 mismatch issue for KleidiAI

Signed-off-by: Feng Guo <feng.guo@nxp.com>
---
 tensorflow/lite/CMakeLists.txt               |  9 ++++++
 tensorflow/lite/cmake/DownloadKleidiAI.cmake | 32 ++++++++++++++++++++
 tensorflow/workspace2.bzl                    |  2 +-
 3 files changed, 42 insertions(+), 1 deletion(-)
 create mode 100644 tensorflow/lite/cmake/DownloadKleidiAI.cmake

diff --git a/tensorflow/lite/CMakeLists.txt b/tensorflow/lite/CMakeLists.txt
index 94febb0c7d5..47ed5f9c3cc 100644
--- a/tensorflow/lite/CMakeLists.txt
+++ b/tensorflow/lite/CMakeLists.txt
@@ -190,6 +190,15 @@ include_directories(
 )
 # Download necessary dependencies.
 if(TFLITE_ENABLE_XNNPACK)
+  IF(NOT DEFINED KLEIDIAI_SOURCE_DIR)
+    MESSAGE(STATUS "Downloading kleidiai to ${CMAKE_BINARY_DIR}/kleidiai-source (define FP16_SOURCE_DIR to avoid it)")
+    CONFIGURE_FILE(cmake/DownloadKleidiAI.cmake "${CMAKE_BINARY_DIR}/kleidiai-download/CMakeLists.txt")
+    EXECUTE_PROCESS(COMMAND "${CMAKE_COMMAND}" -G "${CMAKE_GENERATOR}" .
+      WORKING_DIRECTORY "${CMAKE_BINARY_DIR}/kleidiai-download")
+    EXECUTE_PROCESS(COMMAND "${CMAKE_COMMAND}" --build .
+      WORKING_DIRECTORY "${CMAKE_BINARY_DIR}/kleidiai-download")
+    SET(KLEIDIAI_SOURCE_DIR "${CMAKE_BINARY_DIR}/kleidiai-source" CACHE STRING "kleidiai source directory")
+  ENDIF()
   # pthreadpool is used by XNNPACK.
   if(SYSTEM_PTHREADPOOL)
     find_library(PTHREADPOOL_LIB pthreadpool REQUIRED)
diff --git a/tensorflow/lite/cmake/DownloadKleidiAI.cmake b/tensorflow/lite/cmake/DownloadKleidiAI.cmake
new file mode 100644
index 00000000000..bb640613cb4
--- /dev/null
+++ b/tensorflow/lite/cmake/DownloadKleidiAI.cmake
@@ -0,0 +1,32 @@
+# Copyright 2026 NXP
+# Copyright (c) Facebook, Inc. and its affiliates.
+# All rights reserved.
+#
+# Copyright 2019 Google LLC
+#
+# This source code is licensed under the BSD-style license found in the
+# LICENSE file in the root directory of this source tree.
+
+CMAKE_MINIMUM_REQUIRED(VERSION 3.5 FATAL_ERROR)
+
+PROJECT(kleidiai-download NONE)
+
+# Set file timestamps to the time of extraction.
+IF(POLICY CMP0135)
+  CMAKE_POLICY(SET CMP0135 NEW)
+ENDIF()
+
+# LINT.IfChange
+INCLUDE(ExternalProject)
+ExternalProject_Add(kleidiai
+  URL https://gitlab.arm.com/kleidi/kleidiai/-/archive/cddf991af5de49fd34949fa39690e4e906e04074/kleidiai-cddf991af5de49fd34949fa39690e4e906e04074.zip
+  URL_HASH SHA256=5d4fe6b12ab999b40b26fc2760b3f1e2d134029acd9546541e118494fe11fb03
+  SOURCE_DIR "${CMAKE_BINARY_DIR}/kleidiai-source"
+  BINARY_DIR "${CMAKE_BINARY_DIR}/kleidiai"
+  CONFIGURE_COMMAND ""
+  PATCH_COMMAND ""
+  BUILD_COMMAND ""
+  INSTALL_COMMAND ""
+  TEST_COMMAND ""
+)
+# LINT.ThenChange(../MODULE.bazel:kleidiai)
diff --git a/tensorflow/workspace2.bzl b/tensorflow/workspace2.bzl
index 7a7ecae031e..9facc2c6f04 100644
--- a/tensorflow/workspace2.bzl
+++ b/tensorflow/workspace2.bzl
@@ -162,7 +162,7 @@ def _tf_repositories():
     # XNNPack dependency.
     tf_http_archive(
         name = "KleidiAI",
-        sha256 = "88233e427be6579560073267575f00f3b5fc370a31a43bbdd87a1810bd4bf1b6",
+        sha256 = "5d4fe6b12ab999b40b26fc2760b3f1e2d134029acd9546541e118494fe11fb03",
         strip_prefix = "kleidiai-cddf991af5de49fd34949fa39690e4e906e04074",
         urls = tf_mirror_urls("https://gitlab.arm.com/kleidi/kleidiai/-/archive/cddf991af5de49fd34949fa39690e4e906e04074/kleidiai-cddf991af5de49fd34949fa39690e4e906e04074.zip"),
     )
-- 
2.43.0

